{% extends "base.html" %}

{% block head %}
    <!-- Global chat page specific styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}" />
{% endblock %}

{% block content %}
  <h1>Global Chat</h1>
    <!-- Main chat container, displays all global messages -->
    <div id="chat">
      {% for msg in history %}
        <div class="msg-row {{ 'sent' if msg.username == username else 'received' }}">
          {% if msg.username == username %}
              <!-- For your own messages: show edit/delete menu and reaction picker on the left -->
              <div class="msg-menu-wrapper" data-msg-id="{{ msg.id }}">
                  <button class="msg-menu-btn" type="button">â‹®</button>
                  <div class="msg-menu">
                      <button class="msg-menu-edit" type="button" data-msg-id="{{ msg.id }}">Edit</button>
                      <button class="msg-menu-delete" type="button" data-msg-id="{{ msg.id }}">Delete</button>
                  </div>
              </div>
              <!-- Emoji reaction picker - hover to see available reactions -->
              <div class="reaction-picker-wrapper">
                  <button class="add-reaction-btn">â˜º</button> <div class="reaction-menu">
                      <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ‘">ğŸ‘</span>
                      <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="â¤ï¸">â¤ï¸</span>
                      <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜‚">ğŸ˜‚</span>
                      <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜®">ğŸ˜®</span>
                      <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜¢">ğŸ˜¢</span>
                      <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜¡">ğŸ˜¡</span>
                  </div>
              </div>
          {% endif %}
          
          <!-- The actual message bubble containing text, images, reactions, and timestamp -->
          <div class="msg-bubble {{ 'msg-sent' if msg.username == username else 'msg-received' }}" data-msg-id="{{ msg.id }}">
            {% if msg.username != username %}
              <!-- Show sender's name for other people's messages (clickable to view profile) -->
              <div class="sender-name">
                <a href="{{ url_for('profile', username=msg.username) }}">
                  {{ msg.username }}
                </a>
              </div>
            {% endif %}
            
            {% if msg.image %}
              <!-- Display uploaded image if the message contains one -->
              <img src="{{ url_for('static', filename='chat_uploads/' + msg.image) }}" class="chat-image">
            {% endif %}
            
            {% if msg.msg %}
              <!-- The text content of the message -->
              <div class="msg-text">{{ msg.msg }}</div>
            {% endif %}
                
            <!-- Reaction section showing emoji reactions from users -->
            <div class="msg-reactions">
              <div class="reaction-list" id="reactions-{{ msg.id }}">
                {% for r in msg.reactions %}
                  <!-- Each reaction shows emoji, count, and highlights if you reacted -->
                  <span class="reaction-tag {{ 'active' if r.user_has_reacted else '' }}" 
                        onclick="sendReaction(this)"
                        data-id="{{ msg.id }}"
                        data-emoji="{{ r.emoji }}">
                      {{ r.emoji }} {{ r.count }}
                  </span>
                {% endfor %}
              </div>
            </div>
        
            <!-- Message timestamp showing when it was sent -->
            <div class="msg-time">{{ msg.timestamp }}</div>
          </div>
      
          {% if msg.username != username %}
            <!-- For other people's messages: show reaction picker on the right -->
            <div class="reaction-picker-wrapper">
              <button class="add-reaction-btn">â˜º</button>
              <div class="reaction-menu">
                <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ‘">ğŸ‘</span>
                <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="â¤ï¸">â¤ï¸</span>
                <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜‚">ğŸ˜‚</span>
                <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜®">ğŸ˜®</span>
                <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜¢">ğŸ˜¢</span>
                <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜¡">ğŸ˜¡</span>
              </div>
            </div>
            {# Removed msg-menu-wrapper from here #}
          {% endif %}
        </div>
      {% endfor %}
    </div>

  <!-- Message input controls at the bottom -->
  <div id="controls">
    <!-- Image upload button (camera icon) -->
    <label for="image-input" class="upload-btn">
        ğŸ“·
    </label>
    <input type="file" id="image-input" accept="image/*" style="display: none;">
    
    <!-- Text input area for typing messages -->
    <textarea id="message" placeholder="Type a message..." rows="1"></textarea>
    <!-- Send button (disabled during 10-second cooldown after sending) -->
    <button id="send">Send</button>
</div>
  
  <script>
    // Make the current username available to JavaScript for message handling
    window.currentUsername = "{{ username }}";
  </script>
{% endblock %}

{% block script %}
  <!-- Socket.IO library for real-time communication -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <!-- Main chat functionality: sending/receiving messages, reactions, edit/delete -->
  <script src="{{ url_for('static', filename='js/index.js') }}"></script>
{% endblock %}