{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}" />
{% endblock %}

{% block content %}
  <h1>Global Chat</h1>
    <div id="chat">
        {% for msg in history %}
            <div class="msg-row {{ 'sent' if msg.username == username else 'received' }}">
                
                {% if msg.username == username %}
                    <div class="reaction-picker-wrapper">
                        <button class="add-reaction-btn">â˜º</button> <div class="reaction-menu">
                            <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ‘">ğŸ‘</span>
                            <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="â¤ï¸">â¤ï¸</span>
                            <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜‚">ğŸ˜‚</span>
                            <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜®">ğŸ˜®</span>
                            <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜¢">ğŸ˜¢</span>
                            <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜¡">ğŸ˜¡</span>
                        </div>
                    </div>
                {% endif %}
                
                <div class="msg-bubble {{ 'msg-sent' if msg.username == username else 'msg-received' }}" data-msg-id="{{ msg.id }}">
                    {% if msg.username != username %}
                        <div class="sender-name">
                            <a href="{{ url_for('profile', username=msg.username) }}">
                                {{ msg.username }}
                            </a>
                        </div>
                    {% endif %}
                    
                    {% if msg.image %}
                        <img src="{{ url_for('static', filename='chat_uploads/' + msg.image) }}" class="chat-image">
                    {% endif %}
                    
                    {% if msg.msg %}
                        <div class="msg-text">{{ msg.msg }}</div>
                    {% endif %}
                        
                    <div class="msg-reactions">
                        <div class="reaction-list" id="reactions-{{ msg.id }}">
                            {% for r in msg.reactions %}
                                <span class="reaction-tag {{ 'active' if r.user_has_reacted else '' }}" 
                                      onclick="sendReaction(this)"
                                      data-id="{{ msg.id }}"
                                      data-emoji="{{ r.emoji }}">
                                    {{ r.emoji }} {{ r.count }}
                                </span>
                            {% endfor %}
                        </div>
                    </div>
                
                    <div class="msg-time">{{ msg.timestamp }}</div>
                </div>
            
                {% if msg.username != username %}
                    <div class="reaction-picker-wrapper">
                        <button class="add-reaction-btn">â˜º</button>
                        <div class="reaction-menu">
                            <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ‘">ğŸ‘</span>
                            <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="â¤ï¸">â¤ï¸</span>
                            <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜‚">ğŸ˜‚</span>
                            <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜®">ğŸ˜®</span>
                            <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜¢">ğŸ˜¢</span>
                            <span onclick="sendReaction(this)" data-id="{{ msg.id }}" data-emoji="ğŸ˜¡">ğŸ˜¡</span>
                        </div>
                    </div>
                {% endif %}
                
            </div>
        {% endfor %}
    </div>

  <div id="controls">
    <label for="image-input" class="upload-btn">
        ğŸ“·
    </label>
    <input type="file" id="image-input" accept="image/*" style="display: none;">
    
    <textarea id="message" placeholder="Type a message..." rows="1"></textarea>
    <button id="send">Send</button>
</div>
  
  <script>
    window.currentUsername = "{{ username }}";
  </script>
{% endblock %}

{% block script %}
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='js/index.js') }}"></script>
{% endblock %}